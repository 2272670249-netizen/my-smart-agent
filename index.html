<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>扣子智能体 - 会话隔离测试</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
        }
        .chat-wrapper {
            max-width: 800px;
            margin: 20px auto;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .chat-header {
            background-color: #4096ff;
            color: white;
            padding: 15px;
            font-size: 18px;
            font-weight: bold;
        }
        .chat-history {
            height: 500px;
            padding: 15px;
            overflow-y: auto;
            background-color: #f9f9f9;
        }
        .message {
            margin-bottom: 12px;
            max-width: 80%;
            clear: both;
        }
        .user-message {
            float: right;
        }
        .ai-message {
            float: left;
        }
        .message-content {
            padding: 10px 15px;
            border-radius: 18px;
            line-height: 1.4;
        }
        .user-message .message-content {
            background-color: #4096ff;
            color: white;
            border-bottom-right-radius: 4px;
        }
        .ai-message .message-content {
            background-color: white;
            border: 1px solid #e0e0e0;
            border-bottom-left-radius: 4px;
        }
        .chat-input-area {
            padding: 15px;
            background-color: white;
            border-top: 1px solid #e0e0e0;
            display: flex;
            gap: 10px;
        }
        #message-input {
            flex: 1;
            padding: 12px 15px;
            border: 1px solid #e0e0e0;
            border-radius: 25px;
            outline: none;
            font-size: 14px;
        }
        #message-input:focus {
            border-color: #4096ff;
        }
        #send-btn {
            padding: 12px 25px;
            background-color: #4096ff;
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
        }
        #send-btn:hover {
            background-color: #337ecc;
        }
        #send-btn:disabled {
            background-color: #b3d4fc;
            cursor: not-allowed;
        }
        .session-info {
            padding: 10px 15px;
            font-size: 12px;
            color: #666;
            background-color: #f5f5f5;
            border-bottom: 1px solid #e0e0e0;
        }
        .error-tip {
            color: #ff4d4f;
            font-size: 12px;
            padding: 5px 15px;
            background-color: #fff2f0;
            border-bottom: 1px solid #ffccc7;
        }
    </style>
</head>
<body>
    <div class="chat-wrapper">
        <div class="chat-header">扣子智能体 - 会话隔离测试</div>
        <div class="session-info">当前会话ID：<span id="session-id"></span></div>
        <div class="error-tip" id="error-tip" style="display: none;">
            令牌校验失败！请检查API令牌是否正确，或参考<a href="https://coze.com/docs/developer_guides/authentication" target="_blank">扣子认证文档</a>
        </div>
        <div class="chat-history" id="chat-history"></div>
        <div class="chat-input-area">
            <input type="text" id="message-input" placeholder="请输入你的问题..." autocomplete="off">
            <button id="send-btn">发送</button>
        </div>
    </div>

    <script>
        // 配置信息（已填入你的BotID和API令牌，重点检查这里的令牌是否和控制台一致）
        const CONFIG = {
            BOT_ID: '7578063729297145899',
            // 请确认这个令牌和扣子控制台「发布-API调用」里的令牌完全一致，包括大小写和特殊字符
            API_KEY: 'pat_ZcFFQgalml0fBTb8cpYwFFGAhHtq4NvkzyyCeKDLhkuH1wdCS6ZZ1oa61BqKJeG5',
            API_URL: 'https://api.coze.com/open_api/v2/chat'
        };

        // 1. 生成/获取唯一会话ID（确保每个用户独立）
        function getUniqueSessionId() {
            let sessionId = localStorage.getItem('coze_unique_session_id');
            if (!sessionId) {
                sessionId = `test_${Date.now()}_${Math.random().toString(36).slice(2, 10)}`;
                localStorage.setItem('coze_unique_session_id', sessionId);
            }
            document.getElementById('session-id').textContent = sessionId;
            return sessionId;
        }

        // 2. 发送消息到扣子智能体（重点修复Authorization请求头格式）
        async function sendMessage(message) {
            const sessionId = getUniqueSessionId();
            const sendBtn = document.getElementById('send-btn');
            const input = document.getElementById('message-input');
            const errorTip = document.getElementById('error-tip');
            
            sendBtn.disabled = true;
            input.disabled = true;
            errorTip.style.display = 'none'; // 隐藏错误提示

            try {
                // 核心修复点：确保Bearer和令牌之间有且只有一个空格，Authorization字段拼写正确
                const authHeader = `Bearer ${CONFIG.API_KEY.trim()}`;
                
                const response = await fetch(CONFIG.API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': authHeader, // 修复后的授权头
                        'Accept': 'application/json' // 增加必要的请求头
                    },
                    body: JSON.stringify({
                        bot_id: CONFIG.BOT_ID,
                        user: sessionId,
                        query: message,
                        session_id: sessionId,
                        stream: false,
                        temperature: 0.7
                    })
                });

                const result = await response.json();
                
                // 处理令牌错误，给出明确提示
                if (result.code === 4101) {
                    errorTip.style.display = 'block';
                    return `【令牌错误】${result.msg}
请检查：
1. API令牌是否和扣子控制台完全一致；
2. 令牌是否未过期/未被禁用；
3. 智能体是否已发布（草稿状态无法调用）。`;
                }

                if (result.code === 0 && result.data?.answers?.length > 0) {
                    return result.data.answers[0].content;
                } else {
                    return `【接口错误】${result.msg || '未知错误'} (错误码：${result.code})`;
                }
            } catch (error) {
                return `【网络错误】${error.message}`;
            } finally {
                sendBtn.disabled = false;
                input.disabled = false;
                input.focus();
            }
        }

        // 3. 渲染消息到聊天记录
        function renderMessage(content, isUser = false) {
            const chatHistory = document.getElementById('chat-history');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user-message' : 'ai-message'}`;
            
            const safeContent = content.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/\n/g, '<br>');
            
            messageDiv.innerHTML = `<div class="message-content">${safeContent}</div>`;
            chatHistory.appendChild(messageDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }

        // 4. 绑定页面交互事件
        function initEventListeners() {
            const sendBtn = document.getElementById('send-btn');
            const input = document.getElementById('message-input');

            sendBtn.addEventListener('click', async () => {
                const message = input.value.trim();
                if (!message) return;
                
                input.value = '';
                renderMessage(message, true);
                
                const aiReply = await sendMessage(message);
                renderMessage(aiReply, false);
            });

            input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendBtn.click();
                }
            });
        }

        // 初始化页面
        window.onload = () => {
            getUniqueSessionId();
            initEventListeners();
            document.getElementById('message-input').focus();
        };
    </script>
</body>
</html>
